"0","#| message: false"
"0","#| warning: false"
"0",""
"0","#CRS & radii"
"0","pa_crs <- 2272    # NAD83 / PA South (ftUS)"
"0","mi_to_ft   <- 5280"
"0","r_park_ft   <- 0.25 * mi_to_ft"
"0","r_crime_ft  <- 0.50 * mi_to_ft"
"0","r_school_ft <- 0.50 * mi_to_ft"
"0",""
"0","# turn off spherical geometry (makes buffer/join ops faster)"
"0","sf::sf_use_s2(FALSE)"
"0",""
"0","## CONVERT SALES DATA TO POINTS ##"
"0","OPA_points <- st_transform(OPA_data, pa_crs)"
"0",""
"0","#Drop Z/M if present"
"0","st_geometry(OPA_points) <- st_zm(st_geometry(OPA_points), drop = TRUE, what = ""ZM"")"
"0",""
"0","#Make geometries valid"
"0","st_geometry(OPA_points) <- st_make_valid(st_geometry(OPA_points))"
"0",""
"0","#Ensure POINT geometry (works for points/lines/polygons/collections)"
"0","st_geometry(OPA_points) <- st_point_on_surface(st_geometry(OPA_points))"
"0",""
"0","#Add sale ID"
"0","OPA_points <- OPA_points %>%"
"0","  mutate(sale_id = dplyr::row_number())"
"0",""
"0","#read & project layers"
"0","transit   <- st_read(""./data/Transit_Stops_(Spring_2025)/Transit_Stops_(Spring_2025).shp"", quiet = TRUE) |> st_transform(pa_crs)"
"0","hospitals <- st_read(""./data/Hospitals.geojson"", quiet = TRUE) |> st_transform(pa_crs)"
"0","parksrec  <- st_read(""./data/PPR_Program_Sites.geojson"", quiet = TRUE)|> st_transform(pa_crs)"
"0","schools_polygons   <- st_read(""./data/Schools_Parcels.geojson"", quiet = TRUE) |> st_transform(pa_crs)"
"0","crime_2023     <- st_read(""./data/crime_incidents_2023/incidents_part1_part2.shp"", quiet = TRUE)        |> st_transform(pa_crs)"
"0","crime_2024     <- st_read(""./data/crime_incidents_2024/incidents_part1_part2.shp"", quiet = TRUE)        |> st_transform(pa_crs)"
"0",""
"0","#combine 2023 & 2024 crime datasets"
"0","crime <- rbind(crime_2023, crime_2024)"
"0",""
"0","#create centroids for schools dataset"
"0","schools <- if (any(st_geometry_type(schools_polygons) %in% c(""POLYGON"",""MULTIPOLYGON""))) {"
"0","  st_centroid(schools_polygons, )"
"0","} else {"
"0","  schools_polygons"
"0","}"
"0",""
"0","#crop transit data to philadelphia"
"0","philly_boundary <- st_union(nhoods)"
"0",""
"0","transit <- st_filter(transit, philly_boundary, .predicate = st_within)"
