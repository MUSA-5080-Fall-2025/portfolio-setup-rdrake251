<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ryan Drake">
<meta name="dcterms.date" content="2025-11-30">

<title>Space-Time Prediction of Bike Share Demand: Philadelphia Indego – Ryan Drake - MUSA 5080 Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>

<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">



</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Ryan Drake - MUSA 5080 Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Weekly Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-weekly-notes">    
        <li>
    <a class="dropdown-item" href="../../weekly-notes/">
 <span class="dropdown-text">All Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-01-notes.html">
 <span class="dropdown-text">Week 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-02-notes.html">
 <span class="dropdown-text">Week 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-03-notes.html">
 <span class="dropdown-text">Week 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-04-notes.html">
 <span class="dropdown-text">Week 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-05-notes.html">
 <span class="dropdown-text">Week 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-06-notes.html">
 <span class="dropdown-text">Week 6</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../../Labs/lab_00/lab0_template.html">
 <span class="dropdown-text">Lab 0: Dplyr Basics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-assignments" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Assignments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-assignments">    
        <li>
    <a class="dropdown-item" href="../../Assignments/assignment_01/assignment1_template.html">
 <span class="dropdown-text">Assignment 1: Census Data Exploration</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Assignments/assignment_02/assignment2_template.html">
 <span class="dropdown-text">Assignment 2: Spatial Analysis and Visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Assignments/MUSA-5080-Midterm/model_script.html">
 <span class="dropdown-text">Midterm: Philadelphia Housing Price Prediction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Assignments/MUSA-5080-Midterm/midterm_presentation.html">
 <span class="dropdown-text">Midterm: Presentation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Assignments/assignment_04/assignment4.html">
 <span class="dropdown-text">Assignment 4: Predictive Policing - Technical Implementation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Assignments/assignment_05/assignment_5.html">
 <span class="dropdown-text">Assignment 5: Space-Time Prediction of Bike Share Demand: Philadelphia Indego</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#the-rebalancing-challenge-in-philadelphia" id="toc-the-rebalancing-challenge-in-philadelphia" class="nav-link" data-scroll-target="#the-rebalancing-challenge-in-philadelphia">The Rebalancing Challenge in Philadelphia</a></li>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  </ul></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#load-libraries" id="toc-load-libraries" class="nav-link" data-scroll-target="#load-libraries">Load Libraries</a></li>
  <li><a href="#define-themes" id="toc-define-themes" class="nav-link" data-scroll-target="#define-themes">Define Themes</a></li>
  <li><a href="#set-census-api-key" id="toc-set-census-api-key" class="nav-link" data-scroll-target="#set-census-api-key">Set Census API Key</a></li>
  </ul></li>
  <li><a href="#data-import-preparation" id="toc-data-import-preparation" class="nav-link" data-scroll-target="#data-import-preparation">Data Import &amp; Preparation</a>
  <ul class="collapse">
  <li><a href="#load-indego-trip-data-q3-2025" id="toc-load-indego-trip-data-q3-2025" class="nav-link" data-scroll-target="#load-indego-trip-data-q3-2025">Load Indego Trip Data (Q3 2025)</a></li>
  <li><a href="#examine-the-data-structure" id="toc-examine-the-data-structure" class="nav-link" data-scroll-target="#examine-the-data-structure">Examine the Data Structure</a></li>
  <li><a href="#create-time-bins" id="toc-create-time-bins" class="nav-link" data-scroll-target="#create-time-bins">Create Time Bins</a></li>
  </ul></li>
  <li><a href="#exploratory-analysis" id="toc-exploratory-analysis" class="nav-link" data-scroll-target="#exploratory-analysis">Exploratory Analysis</a>
  <ul class="collapse">
  <li><a href="#trips-over-time" id="toc-trips-over-time" class="nav-link" data-scroll-target="#trips-over-time">Trips Over Time</a></li>
  <li><a href="#hourly-patterns" id="toc-hourly-patterns" class="nav-link" data-scroll-target="#hourly-patterns">Hourly Patterns</a></li>
  <li><a href="#top-stations" id="toc-top-stations" class="nav-link" data-scroll-target="#top-stations">Top Stations</a></li>
  </ul></li>
  <li><a href="#get-philadelphia-spatial-context" id="toc-get-philadelphia-spatial-context" class="nav-link" data-scroll-target="#get-philadelphia-spatial-context">Get Philadelphia Spatial Context</a>
  <ul class="collapse">
  <li><a href="#load-philadelphia-census-data" id="toc-load-philadelphia-census-data" class="nav-link" data-scroll-target="#load-philadelphia-census-data">Load Philadelphia Census Data</a></li>
  <li><a href="#map-philadelphia-context" id="toc-map-philadelphia-context" class="nav-link" data-scroll-target="#map-philadelphia-context">Map Philadelphia Context</a></li>
  <li><a href="#join-census-data-to-stations" id="toc-join-census-data-to-stations" class="nav-link" data-scroll-target="#join-census-data-to-stations">Join Census Data to Stations</a></li>
  </ul></li>
  <li><a href="#dealing-with-missing-data" id="toc-dealing-with-missing-data" class="nav-link" data-scroll-target="#dealing-with-missing-data">Dealing with missing data</a></li>
  <li><a href="#get-weather-data" id="toc-get-weather-data" class="nav-link" data-scroll-target="#get-weather-data">Get Weather Data</a>
  <ul class="collapse">
  <li><a href="#visualize-weather-patterns" id="toc-visualize-weather-patterns" class="nav-link" data-scroll-target="#visualize-weather-patterns">Visualize Weather Patterns</a></li>
  </ul></li>
  <li><a href="#create-space-time-panel" id="toc-create-space-time-panel" class="nav-link" data-scroll-target="#create-space-time-panel">Create Space-Time Panel</a>
  <ul class="collapse">
  <li><a href="#aggregate-trips-to-station-hour-level" id="toc-aggregate-trips-to-station-hour-level" class="nav-link" data-scroll-target="#aggregate-trips-to-station-hour-level">Aggregate Trips to Station-Hour Level</a></li>
  <li><a href="#create-complete-panel-structure" id="toc-create-complete-panel-structure" class="nav-link" data-scroll-target="#create-complete-panel-structure">Create Complete Panel Structure</a></li>
  <li><a href="#add-time-features" id="toc-add-time-features" class="nav-link" data-scroll-target="#add-time-features">Add Time Features</a></li>
  <li><a href="#join-weather-data" id="toc-join-weather-data" class="nav-link" data-scroll-target="#join-weather-data">Join Weather Data</a></li>
  </ul></li>
  <li><a href="#create-temporal-lag-variables" id="toc-create-temporal-lag-variables" class="nav-link" data-scroll-target="#create-temporal-lag-variables">Create Temporal Lag Variables</a>
  <ul class="collapse">
  <li><a href="#visualize-lag-correlations" id="toc-visualize-lag-correlations" class="nav-link" data-scroll-target="#visualize-lag-correlations">Visualize Lag Correlations</a></li>
  </ul></li>
  <li><a href="#temporal-traintest-split" id="toc-temporal-traintest-split" class="nav-link" data-scroll-target="#temporal-traintest-split">Temporal Train/Test Split</a>
  <ul class="collapse">
  <li><a href="#why-temporal-validation-matters" id="toc-why-temporal-validation-matters" class="nav-link" data-scroll-target="#why-temporal-validation-matters">Why Temporal Validation Matters</a></li>
  </ul></li>
  <li><a href="#build-predictive-models" id="toc-build-predictive-models" class="nav-link" data-scroll-target="#build-predictive-models">Build Predictive Models</a>
  <ul class="collapse">
  <li><a href="#model-1-baseline-time-weather" id="toc-model-1-baseline-time-weather" class="nav-link" data-scroll-target="#model-1-baseline-time-weather">Model 1: Baseline (Time + Weather)</a></li>
  <li><a href="#model-2-add-temporal-lags" id="toc-model-2-add-temporal-lags" class="nav-link" data-scroll-target="#model-2-add-temporal-lags">Model 2: Add Temporal Lags</a></li>
  <li><a href="#model-3-add-demographics" id="toc-model-3-add-demographics" class="nav-link" data-scroll-target="#model-3-add-demographics">Model 3: Add Demographics</a></li>
  <li><a href="#model-4-add-station-fixed-effects" id="toc-model-4-add-station-fixed-effects" class="nav-link" data-scroll-target="#model-4-add-station-fixed-effects">Model 4: Add Station Fixed Effects</a></li>
  <li><a href="#model-5-add-rush-hour-interaction" id="toc-model-5-add-rush-hour-interaction" class="nav-link" data-scroll-target="#model-5-add-rush-hour-interaction">Model 5: Add Rush Hour Interaction</a></li>
  </ul></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation">Model Evaluation</a>
  <ul class="collapse">
  <li><a href="#calculate-predictions-and-mae" id="toc-calculate-predictions-and-mae" class="nav-link" data-scroll-target="#calculate-predictions-and-mae">Calculate Predictions and MAE</a></li>
  <li><a href="#visualize-model-comparison" id="toc-visualize-model-comparison" class="nav-link" data-scroll-target="#visualize-model-comparison">Visualize Model Comparison</a></li>
  </ul></li>
  <li><a href="#space-time-error-analysis" id="toc-space-time-error-analysis" class="nav-link" data-scroll-target="#space-time-error-analysis">Space-Time Error Analysis</a>
  <ul class="collapse">
  <li><a href="#observed-vs.-predicted" id="toc-observed-vs.-predicted" class="nav-link" data-scroll-target="#observed-vs.-predicted">Observed vs.&nbsp;Predicted</a></li>
  <li><a href="#spatial-error-patterns" id="toc-spatial-error-patterns" class="nav-link" data-scroll-target="#spatial-error-patterns">Spatial Error Patterns</a></li>
  <li><a href="#temporal-error-patterns" id="toc-temporal-error-patterns" class="nav-link" data-scroll-target="#temporal-error-patterns">Temporal Error Patterns</a></li>
  <li><a href="#errors-and-demographics" id="toc-errors-and-demographics" class="nav-link" data-scroll-target="#errors-and-demographics">Errors and Demographics</a></li>
  <li><a href="#part-3-feature-engineering-model-improvement-adding-2-3-new-features-to-improve-the-model" id="toc-part-3-feature-engineering-model-improvement-adding-2-3-new-features-to-improve-the-model" class="nav-link" data-scroll-target="#part-3-feature-engineering-model-improvement-adding-2-3-new-features-to-improve-the-model">Part 3: Feature Engineering &amp; model improvement: Adding 2-3 new features to improve the model:</a></li>
  <li><a href="#add-feature-1-same-hour-last-week" id="toc-add-feature-1-same-hour-last-week" class="nav-link" data-scroll-target="#add-feature-1-same-hour-last-week">Add Feature 1: same hour last week</a></li>
  <li><a href="#model-6-add-same-hour-one-week-lag" id="toc-model-6-add-same-hour-one-week-lag" class="nav-link" data-scroll-target="#model-6-add-same-hour-one-week-lag">Model 6: Add same hour one week lag</a></li>
  <li><a href="#add-feature-2-feels-like-weather" id="toc-add-feature-2-feels-like-weather" class="nav-link" data-scroll-target="#add-feature-2-feels-like-weather">Add Feature 2: “feels-like” weather</a></li>
  <li><a href="#model-7-add-feels-like-weather" id="toc-model-7-add-feels-like-weather" class="nav-link" data-scroll-target="#model-7-add-feels-like-weather">Model 7: Add “feels-like” weather</a></li>
  <li><a href="#model-7-predictive-errors" id="toc-model-7-predictive-errors" class="nav-link" data-scroll-target="#model-7-predictive-errors">Model 7: Predictive Errors</a></li>
  <li><a href="#part-4-critical-reflection" id="toc-part-4-critical-reflection" class="nav-link" data-scroll-target="#part-4-critical-reflection">Part 4: Critical Reflection</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Space-Time Prediction of Bike Share Demand: Philadelphia Indego</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ryan Drake </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 30, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="the-rebalancing-challenge-in-philadelphia" class="level2">
<h2 class="anchored" data-anchor-id="the-rebalancing-challenge-in-philadelphia">The Rebalancing Challenge in Philadelphia</h2>
<p>Philadelphia’s Indego bike share system faces the same operational challenge as every bike share system: <strong>rebalancing bikes to meet anticipated demand</strong>.</p>
</section>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>This assignment will be able to:</p>
<ol type="1">
<li><strong>Understand panel data structure</strong> for space-time analysis</li>
<li><strong>Create temporal lag variables</strong> to capture demand persistence</li>
<li><strong>Build multiple predictive models</strong> with increasing complexity</li>
<li><strong>Validate models temporally</strong> (train on past, test on future)</li>
<li><strong>Analyze prediction errors</strong> in both space and time</li>
<li><strong>Engineer new features</strong> based on error patterns</li>
<li><strong>Critically evaluate</strong> when prediction errors matter most</li>
</ol>
<hr>
</section>
</section>
<section id="setup" class="level1">
<h1>Setup</h1>
<section id="load-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-libraries">Load Libraries</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core tidyverse</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial data</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Census data</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Weather data</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(riem)  <span class="co"># For Philadelphia weather from ASOS stations</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># here!</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Get rid of scientific notation. We gotta look good!</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="define-themes" class="level2">
<h2 class="anchored" data-anchor-id="define-themes">Define Themes</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>plotTheme <span class="ot">&lt;-</span> <span class="fu">theme</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">"#D0D0D0"</span>, <span class="at">size =</span> <span class="fl">0.2</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>mapTheme <span class="ot">&lt;-</span> <span class="fu">theme</span>(</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.line =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">'transparent'</span>),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="st">'cm'</span>),</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>palette5 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#eff3ff"</span>, <span class="st">"#bdd7e7"</span>, <span class="st">"#6baed6"</span>, <span class="st">"#3182bd"</span>, <span class="st">"#08519c"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="set-census-api-key" class="level2">
<h2 class="anchored" data-anchor-id="set-census-api-key">Set Census API Key</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">census_api_key</span>(<span class="st">"a55638f442ab081818dbf0ae29a32549253a2ab0"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>, <span class="at">install =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
<section id="data-import-preparation" class="level1">
<h1>Data Import &amp; Preparation</h1>
<section id="load-indego-trip-data-q3-2025" class="level2">
<h2 class="anchored" data-anchor-id="load-indego-trip-data-q3-2025">Load Indego Trip Data (Q3 2025)</h2>
<p>Quarter three was chosen to investigate the summer months in comparison to winter months bike share usage. Increased usage and more sporadic usage is expected since people tend to bike more during the summer than the winter - and more for leisure during the summer.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read Q3 2025 data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>indego <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"C:/Users/rydra/OneDrive - PennO365/CPLN 5080 Public Policy/portfolio-setup-rdrake251/Assignments/assignment_05/indego-trips-2025-q3.csv"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick look at the data</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(indego)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 465,464
Columns: 15
$ trip_id             &lt;dbl&gt; 1203073573, 1203073759, 1203073753, 1203073877, 12…
$ duration            &lt;dbl&gt; 10, 19, 16, 19, 2, 6, 20, 4, 52, 3, 31, 9, 10, 9, …
$ start_time          &lt;chr&gt; "7/1/2025 0:06", "7/1/2025 0:11", "7/1/2025 0:13",…
$ end_time            &lt;chr&gt; "7/1/2025 0:16", "7/1/2025 0:30", "7/1/2025 0:29",…
$ start_station       &lt;dbl&gt; 3163, 3304, 3394, 3207, 3061, 3320, 3201, 3078, 32…
$ start_lat           &lt;dbl&gt; 39.94974, 39.94234, 39.92400, 39.95441, 39.95425, …
$ start_lon           &lt;dbl&gt; -75.18097, -75.15399, -75.16959, -75.19200, -75.17…
$ end_station         &lt;dbl&gt; 3374, 3315, 3394, 3368, 3156, 3320, 3196, 3235, 32…
$ end_lat             &lt;dbl&gt; 39.97280, 39.94235, 39.92400, 39.97647, 39.95381, …
$ end_lon             &lt;dbl&gt; -75.17971, -75.21138, -75.16959, -75.17362, -75.17…
$ bike_id             &lt;chr&gt; "31674", "29473", "27889", "31825", "25400", "3172…
$ plan_duration       &lt;dbl&gt; 30, 1, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30,…
$ trip_route_category &lt;chr&gt; "One Way", "One Way", "Round Trip", "One Way", "On…
$ passholder_type     &lt;chr&gt; "Indego30", "Walk-up", "Indego30", "Indego30", "In…
$ bike_type           &lt;chr&gt; "electric", "electric", "electric", "electric", "e…</code></pre>
</div>
</div>
</section>
<section id="examine-the-data-structure" class="level2">
<h2 class="anchored" data-anchor-id="examine-the-data-structure">Examine the Data Structure</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many trips?</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total trips in Q3 2025:"</span>, <span class="fu">nrow</span>(indego), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total trips in Q3 2025: 465464 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Date range</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Date range:"</span>, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(<span class="fu">mdy_hm</span>(indego<span class="sc">$</span>start_time)), <span class="st">"to"</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(<span class="fu">mdy_hm</span>(indego<span class="sc">$</span>start_time)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date range: 1751328360 to 1759276680 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique stations?</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Unique start stations:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(indego<span class="sc">$</span>start_station)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unique start stations: 284 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Trip types</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>trip_route_category)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   One Way Round Trip 
    434518      30946 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Passholder types</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>passholder_type)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
 Day Pass  Indego30 Indego365      NULL   Walk-up 
    18418    252897    157695         5     36449 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bike types</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(indego<span class="sc">$</span>bike_type)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
electric standard 
  299515   165949 </code></pre>
</div>
</div>
</section>
<section id="create-time-bins" class="level2">
<h2 class="anchored" data-anchor-id="create-time-bins">Create Time Bins</h2>
<p>We need to aggregate trips into hourly intervals for our panel data structure.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>indego <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse datetime</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_datetime =</span> <span class="fu">mdy_hm</span>(start_time),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_datetime =</span> <span class="fu">mdy_hm</span>(end_time),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create hourly bins</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval60 =</span> <span class="fu">floor_date</span>(start_datetime, <span class="at">unit =</span> <span class="st">"hour"</span>),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract time features</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> <span class="fu">week</span>(interval60),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">dotw =</span> <span class="fu">wday</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">hour =</span> <span class="fu">hour</span>(interval60),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(interval60),</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create useful indicators</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekend =</span> <span class="fu">ifelse</span>(dotw <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">rush_hour =</span> <span class="fu">ifelse</span>(hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at temporal features</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(indego <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_datetime, interval60, week, dotw, hour, weekend))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  start_datetime      interval60           week dotw   hour weekend
  &lt;dttm&gt;              &lt;dttm&gt;              &lt;dbl&gt; &lt;ord&gt; &lt;int&gt;   &lt;dbl&gt;
1 2025-07-01 00:06:00 2025-07-01 00:00:00    26 Tue       0       0
2 2025-07-01 00:11:00 2025-07-01 00:00:00    26 Tue       0       0
3 2025-07-01 00:13:00 2025-07-01 00:00:00    26 Tue       0       0
4 2025-07-01 00:16:00 2025-07-01 00:00:00    26 Tue       0       0
5 2025-07-01 00:16:00 2025-07-01 00:00:00    26 Tue       0       0
6 2025-07-01 00:18:00 2025-07-01 00:00:00    26 Tue       0       0</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="exploratory-analysis" class="level1">
<h1>Exploratory Analysis</h1>
<section id="trips-over-time" class="level2">
<h2 class="anchored" data-anchor-id="trips-over-time">Trips Over Time</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily trip counts</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>daily_trips <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">trips =</span> <span class="fu">n</span>())</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily_trips, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> trips)) <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#3182bd"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Indego Daily Ridership - Q3 2025"</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Summer demand patterns in Philadelphia"</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Daily Trips"</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Indego bike share"</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/trips_over_time-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> What patterns do you see? How does ridership change over time?</p>
<p>Ridership increased overall from July to October. I would have thought they are very popular in the summer and ridership would be highest but of course the increase coincides with the school year and move in during late August. It may be that when students, who often don’t have cars, need to get around the city they may turn to bike share options.</p>
</section>
<section id="hourly-patterns" class="level2">
<h2 class="anchored" data-anchor-id="hourly-patterns">Hourly Patterns</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Average trips by hour and day type</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>hourly_patterns <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hour, weekend) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg_trips =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="fu">n_distinct</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day_type =</span> <span class="fu">ifelse</span>(weekend <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hourly_patterns, <span class="fu">aes</span>(<span class="at">x =</span> hour, <span class="at">y =</span> avg_trips, <span class="at">color =</span> day_type)) <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span>)) <span class="sc">+</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Average Hourly Ridership Patterns"</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Clear commute patterns on weekdays"</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hour of Day"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Trips per Hour"</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Day Type"</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/hourly_patterns-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> When are the peak hours? How do weekends differ from weekdays?</p>
<p>These results are as expected. Weekdays see peak hours during morning and evening rush hours as people are getting to and from work. The weekends have a more gradual rise and fall during the day as there are not generally rush hours for people. Also ridership goes later in the night on the weekend with the weekend night crowds.</p>
</section>
<section id="top-stations" class="level2">
<h2 class="anchored" data-anchor-id="top-stations">Top Stations</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Most popular origin stations</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>top_stations <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(start_station, start_lat, start_lon, <span class="at">name =</span> <span class="st">"trips"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(trips)) <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">20</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(top_stations, </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Top 20 Indego Stations by Trip Origins"</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">","</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Top 20 Indego Stations by Trip Origins</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">start_station</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_lat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_lon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">trips</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3,010</td>
<td style="text-align: right;">39.94711</td>
<td style="text-align: right;">-75.16618</td>
<td style="text-align: right;">7,716</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,032</td>
<td style="text-align: right;">39.94527</td>
<td style="text-align: right;">-75.17971</td>
<td style="text-align: right;">5,884</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,213</td>
<td style="text-align: right;">39.93887</td>
<td style="text-align: right;">-75.16663</td>
<td style="text-align: right;">5,660</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,163</td>
<td style="text-align: right;">39.94974</td>
<td style="text-align: right;">-75.18097</td>
<td style="text-align: right;">5,174</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,359</td>
<td style="text-align: right;">39.94888</td>
<td style="text-align: right;">-75.16978</td>
<td style="text-align: right;">4,681</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,185</td>
<td style="text-align: right;">39.95169</td>
<td style="text-align: right;">-75.15888</td>
<td style="text-align: right;">4,670</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,028</td>
<td style="text-align: right;">39.94061</td>
<td style="text-align: right;">-75.14958</td>
<td style="text-align: right;">4,607</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,020</td>
<td style="text-align: right;">39.94855</td>
<td style="text-align: right;">-75.19007</td>
<td style="text-align: right;">4,556</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,022</td>
<td style="text-align: right;">39.95472</td>
<td style="text-align: right;">-75.18323</td>
<td style="text-align: right;">4,475</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,066</td>
<td style="text-align: right;">39.94561</td>
<td style="text-align: right;">-75.17348</td>
<td style="text-align: right;">4,353</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,059</td>
<td style="text-align: right;">39.96244</td>
<td style="text-align: right;">-75.16121</td>
<td style="text-align: right;">4,265</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,063</td>
<td style="text-align: right;">39.94633</td>
<td style="text-align: right;">-75.16980</td>
<td style="text-align: right;">4,230</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,161</td>
<td style="text-align: right;">39.95486</td>
<td style="text-align: right;">-75.18091</td>
<td style="text-align: right;">4,223</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,101</td>
<td style="text-align: right;">39.94295</td>
<td style="text-align: right;">-75.15955</td>
<td style="text-align: right;">4,183</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,054</td>
<td style="text-align: right;">39.96250</td>
<td style="text-align: right;">-75.17420</td>
<td style="text-align: right;">4,117</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,030</td>
<td style="text-align: right;">39.93935</td>
<td style="text-align: right;">-75.15716</td>
<td style="text-align: right;">3,986</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,362</td>
<td style="text-align: right;">39.94816</td>
<td style="text-align: right;">-75.16226</td>
<td style="text-align: right;">3,965</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,061</td>
<td style="text-align: right;">39.95425</td>
<td style="text-align: right;">-75.17761</td>
<td style="text-align: right;">3,716</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3,057</td>
<td style="text-align: right;">39.96439</td>
<td style="text-align: right;">-75.17987</td>
<td style="text-align: right;">3,668</td>
</tr>
<tr class="even">
<td style="text-align: right;">3,296</td>
<td style="text-align: right;">39.95134</td>
<td style="text-align: right;">-75.16758</td>
<td style="text-align: right;">3,665</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
</section>
<section id="get-philadelphia-spatial-context" class="level1">
<h1>Get Philadelphia Spatial Context</h1>
<section id="load-philadelphia-census-data" class="level2">
<h2 class="anchored" data-anchor-id="load-philadelphia-census-data">Load Philadelphia Census Data</h2>
<p>We’ll get census tract data to add demographic context to our stations.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get Philadelphia census tracts</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>philly_census <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">geography =</span> <span class="st">"tract"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="fu">c</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B01003_001"</span>,  <span class="co"># Total population</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B19013_001"</span>,  <span class="co"># Median household income</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B08301_001"</span>,  <span class="co"># Total commuters</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B08301_010"</span>,  <span class="co"># Commute by transit</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B02001_002"</span>,  <span class="co"># White alone</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B25077_001"</span>   <span class="co"># Median home value</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="st">"PA"</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">county =</span> <span class="st">"Philadelphia"</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2022</span>,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"wide"</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Pop =</span> B01003_001E,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Inc =</span> B19013_001E,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Commuters =</span> B08301_001E,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">Transit_Commuters =</span> B08301_010E,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">White_Pop =</span> B02001_002E,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Home_Value =</span> B25077_001E</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_Taking_Transit =</span> (Transit_Commuters <span class="sc">/</span> Total_Commuters) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_White =</span> (White_Pop <span class="sc">/</span> Total_Pop) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>)  <span class="co"># WGS84 for lat/lon matching</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |===                                                                   |   5%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |=======                                                               |  11%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |========                                                              |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |==================                                                    |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |========================                                              |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |=================================                                     |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |===================================                                   |  51%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |=====================================                                 |  54%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |========================================                              |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |==========================================                            |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |==============================================                        |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |==================================================================    |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |====================================================================  |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the data</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(philly_census)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 408
Columns: 17
$ GEOID                  &lt;chr&gt; "42101001500", "42101001800", "42101002802", "4…
$ NAME                   &lt;chr&gt; "Census Tract 15; Philadelphia County; Pennsylv…
$ Total_Pop              &lt;dbl&gt; 3251, 3300, 5720, 4029, 4415, 1815, 3374, 2729,…
$ B01003_001M            &lt;dbl&gt; 677, 369, 796, 437, 853, 210, 480, 734, 763, 11…
$ Med_Inc                &lt;dbl&gt; 110859, 114063, 78871, 61583, 32347, 48581, 597…
$ B19013_001M            &lt;dbl&gt; 24975, 30714, 20396, 22293, 4840, 13812, 6278, …
$ Total_Commuters        &lt;dbl&gt; 2073, 2255, 3032, 2326, 1980, 969, 2427, 708, 2…
$ B08301_001M            &lt;dbl&gt; 387, 308, 478, 383, 456, 189, 380, 281, 456, 68…
$ Transit_Commuters      &lt;dbl&gt; 429, 123, 685, 506, 534, 192, 658, 218, 438, 51…
$ B08301_010M            &lt;dbl&gt; 188, 66, 219, 144, 285, 71, 278, 184, 176, 235,…
$ White_Pop              &lt;dbl&gt; 2185, 2494, 3691, 3223, 182, 984, 2111, 231, 35…
$ B02001_002M            &lt;dbl&gt; 268, 381, 592, 380, 88, 190, 463, 112, 238, 778…
$ Med_Home_Value         &lt;dbl&gt; 568300, 605000, 350600, 296400, 76600, 289700, …
$ B25077_001M            &lt;dbl&gt; 58894, 34876, 12572, 22333, 10843, 118720, 1506…
$ geometry               &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-75.16558 3..., MU…
$ Percent_Taking_Transit &lt;dbl&gt; 20.694645, 5.454545, 22.592348, 21.754084, 26.9…
$ Percent_White          &lt;dbl&gt; 67.2100892, 75.5757576, 64.5279720, 79.9950360,…</code></pre>
</div>
</div>
</section>
<section id="map-philadelphia-context" class="level2">
<h2 class="anchored" data-anchor-id="map-philadelphia-context">Map Philadelphia Context</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map median income</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="fu">aes</span>(<span class="at">fill =</span> Med_Inc), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Median</span><span class="sc">\n</span><span class="st">Income"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>dollar</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Median Household Income by Census Tract"</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Context for understanding bike share demand patterns"</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations </span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> indego,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.25</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  mapTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/map_philly-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="join-census-data-to-stations" class="level2">
<h2 class="anchored" data-anchor-id="join-census-data-to-stations">Join Census Data to Stations</h2>
<p>We’ll spatially join census characteristics to each bike station.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sf object for stations</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>stations_sf <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"start_lon"</span>, <span class="st">"start_lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join to get census tract for each station</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>stations_census <span class="ot">&lt;-</span> <span class="fu">st_join</span>(stations_sf, philly_census, <span class="at">left =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the result - investigate whether all of the stations joined to census data -- according to the map above there are stations in non-residential tracts.</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>stations_for_map <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc),</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">has_census =</span> <span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add back to trip data</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>indego_census <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> </span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>             Percent_White, Total_Pop),</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for visualization</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>stations_for_map <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station, start_lat, start_lon) <span class="sc">%&gt;%</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat), <span class="sc">!</span><span class="fu">is.na</span>(start_lon)) <span class="sc">%&gt;%</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc),</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">has_census =</span> <span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the map showing problem stations</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="fu">aes</span>(<span class="at">fill =</span> Med_Inc), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Median</span><span class="sc">\n</span><span class="st">Income"</span>,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span>dollar,</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">"grey90"</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations with census data (small grey dots)</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stations_for_map <span class="sc">%&gt;%</span> <span class="fu">filter</span>(has_census),</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"grey30"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.6</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stations WITHOUT census data (red X marks the spot)</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> stations_for_map <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>has_census),</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat),</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Median Household Income by Census Tract"</span>,</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Indego stations shown (RED = no census data match)"</span>,</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red X marks indicate stations that didn't join to census tracts"</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>  mapTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/join_census_to_stations-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="dealing-with-missing-data" class="level1">
<h1>Dealing with missing data</h1>
<p>We need to decide what to do with the non-residential bike share stations. For this example, we are going to remove them – this is not necessarily the right way to do things always, but for the sake of simplicity, we are narrowing our scope to only stations in residential neighborhoods. We might opt to create a separate model for non-residential stations..</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify which stations to keep</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>valid_stations <span class="ot">&lt;-</span> stations_census <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Med_Inc)) <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter trip data to valid stations only</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>indego_census <span class="ot">&lt;-</span> indego <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">%in%</span> valid_stations) <span class="sc">%&gt;%</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    stations_census <span class="sc">%&gt;%</span> </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>             Percent_White, Total_Pop),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="get-weather-data" class="level1">
<h1>Get Weather Data</h1>
<p>Weather significantly affects bike share demand! Let’s get hourly weather for Philadelphia.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get weather from Philadelphia International Airport (KPHL)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This covers Q1 2025: January 1 - March 31</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>weather_data <span class="ot">&lt;-</span> <span class="fu">riem_measures</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">station =</span> <span class="st">"PHL"</span>,  <span class="co"># Philadelphia International Airport</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_start =</span> <span class="st">"2025-07-01"</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_end =</span> <span class="st">"2025-09-30"</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Process weather data</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>weather_processed <span class="ot">&lt;-</span> weather_data <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval60 =</span> <span class="fu">floor_date</span>(valid, <span class="at">unit =</span> <span class="st">"hour"</span>),</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Temperature =</span> tmpf,  <span class="co"># Temperature in Fahrenheit</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Feel =</span> feel, <span class="co">#Feels like temperature in Fahrenheit</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Precipitation =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(p01i), <span class="dv">0</span>, p01i),  <span class="co"># Hourly precip in inches</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Wind_Speed =</span> sknt  <span class="co"># Wind speed in knots</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(interval60, Temperature, Precipitation, Feel, Wind_Speed) <span class="sc">%&gt;%</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing hours and interpolate if needed</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>weather_complete <span class="ot">&lt;-</span> weather_processed <span class="sc">%&gt;%</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">interval60 =</span> <span class="fu">seq</span>(<span class="fu">min</span>(interval60), <span class="fu">max</span>(interval60), <span class="at">by =</span> <span class="st">"hour"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(Temperature, Precipitation, Feel, Wind_Speed, <span class="at">.direction =</span> <span class="st">"down"</span>)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the weather</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(weather_complete <span class="sc">%&gt;%</span> <span class="fu">select</span>(Temperature, Precipitation, Feel, Wind_Speed))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Temperature    Precipitation           Feel          Wind_Speed    
 Min.   :57.00   Min.   :0.000000   Min.   : 57.00   Min.   : 0.000  
 1st Qu.:70.00   1st Qu.:0.000000   1st Qu.: 70.00   1st Qu.: 4.000  
 Median :76.00   Median :0.000000   Median : 76.00   Median : 6.000  
 Mean   :75.73   Mean   :0.008013   Mean   : 76.96   Mean   : 6.421  
 3rd Qu.:81.00   3rd Qu.:0.000000   3rd Qu.: 82.32   3rd Qu.: 9.000  
 Max.   :98.00   Max.   :1.390000   Max.   :108.59   Max.   :29.000  </code></pre>
</div>
</div>
<section id="visualize-weather-patterns" class="level2">
<h2 class="anchored" data-anchor-id="visualize-weather-patterns">Visualize Weather Patterns</h2>
<p>Who is ready for a Philly winter?!</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_complete, <span class="fu">aes</span>(<span class="at">x =</span> interval60, <span class="at">y =</span> Temperature)) <span class="sc">+</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#3182bd"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Philadelphia Temperature - Q3 2025"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Summer to early fall transition"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Temperature (°F)"</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/visualize_weather-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="create-space-time-panel" class="level1">
<h1>Create Space-Time Panel</h1>
<section id="aggregate-trips-to-station-hour-level" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-trips-to-station-hour-level">Aggregate Trips to Station-Hour Level</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count trips by station-hour</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>trips_panel <span class="ot">&lt;-</span> indego_census <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(interval60, start_station, start_lat, start_lon,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>           Med_Inc, Percent_Taking_Transit, Percent_White, Total_Pop) <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Trip_Count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># How many station-hour observations?</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(trips_panel)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 214178</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique stations?</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 263</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many unique hours?</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2208</code></pre>
</div>
</div>
</section>
<section id="create-complete-panel-structure" class="level2">
<h2 class="anchored" data-anchor-id="create-complete-panel-structure">Create Complete Panel Structure</h2>
<p>Not every station has trips every hour. We need a <strong>complete panel</strong> where every station-hour combination exists (even if Trip_Count = 0).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate expected panel size</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>n_stations <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>n_hours <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>expected_rows <span class="ot">&lt;-</span> n_stations <span class="sc">*</span> n_hours</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Expected panel rows:"</span>, <span class="fu">format</span>(expected_rows, <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Expected panel rows: 580,704 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Current rows:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(trips_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Current rows: 214,178 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Missing rows:"</span>, <span class="fu">format</span>(expected_rows <span class="sc">-</span> <span class="fu">nrow</span>(trips_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Missing rows: 366,526 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create complete panel</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">interval60 =</span> <span class="fu">unique</span>(trips_panel<span class="sc">$</span>interval60),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_station =</span> <span class="fu">unique</span>(trips_panel<span class="sc">$</span>start_station)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join trip counts</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(trips_panel, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"interval60"</span>, <span class="st">"start_station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace NA trip counts with 0</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trip_Count =</span> <span class="fu">replace_na</span>(Trip_Count, <span class="dv">0</span>))</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill in station attributes (they're the same for all hours)</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>station_attributes <span class="ot">&lt;-</span> trips_panel <span class="sc">%&gt;%</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_lat =</span> <span class="fu">first</span>(start_lat),</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_lon =</span> <span class="fu">first</span>(start_lon),</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Med_Inc =</span> <span class="fu">first</span>(Med_Inc),</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_Taking_Transit =</span> <span class="fu">first</span>(Percent_Taking_Transit),</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Percent_White =</span> <span class="fu">first</span>(Percent_White),</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Pop =</span> <span class="fu">first</span>(Total_Pop)</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_attributes, <span class="at">by =</span> <span class="st">"start_station"</span>)</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify we have complete panel</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Complete panel rows:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(study_panel), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Complete panel rows: 580,704 </code></pre>
</div>
</div>
</section>
<section id="add-time-features" class="level2">
<h2 class="anchored" data-anchor-id="add-time-features">Add Time Features</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> <span class="fu">week</span>(interval60),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dotw =</span> <span class="fu">wday</span>(interval60, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">hour =</span> <span class="fu">hour</span>(interval60),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(interval60),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekend =</span> <span class="fu">ifelse</span>(dotw <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">rush_hour =</span> <span class="fu">ifelse</span>(hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">17</span>, <span class="dv">18</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="join-weather-data" class="level2">
<h2 class="anchored" data-anchor-id="join-weather-data">Join Weather Data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(weather_complete, <span class="at">by =</span> <span class="st">"interval60"</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(study_panel <span class="sc">%&gt;%</span> <span class="fu">select</span>(Trip_Count, Temperature, Precipitation, Feel))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Trip_Count       Temperature    Precipitation        Feel       
 Min.   : 0.0000   Min.   :57.00   Min.   :0.000   Min.   : 57.00  
 1st Qu.: 0.0000   1st Qu.:70.00   1st Qu.:0.000   1st Qu.: 70.00  
 Median : 0.0000   Median :76.00   Median :0.000   Median : 76.00  
 Mean   : 0.7236   Mean   :75.73   Mean   :0.008   Mean   : 76.96  
 3rd Qu.: 1.0000   3rd Qu.:81.00   3rd Qu.:0.000   3rd Qu.: 82.32  
 Max.   :22.0000   Max.   :98.00   Max.   :1.390   Max.   :108.59  
                   NA's   :6312    NA's   :6312    NA's   :6312    </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="create-temporal-lag-variables" class="level1">
<h1>Create Temporal Lag Variables</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by station and time</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(start_station, interval60)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create lag variables WITHIN each station</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>study_panel <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag1Hour =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">1</span>),</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag2Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">2</span>),</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag3Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">3</span>),</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag12Hours =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">12</span>),</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag1day =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">24</span>),</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag1week =</span> <span class="fu">lag</span>(Trip_Count, <span class="dv">168</span>),</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with NA lags (first 24 hours for each station)</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>study_panel_complete <span class="ot">&lt;-</span> study_panel <span class="sc">%&gt;%</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lag1week))</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows after removing NA lags:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(study_panel_complete), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows after removing NA lags: 671,439 </code></pre>
</div>
</div>
<section id="visualize-lag-correlations" class="level2">
<h2 class="anchored" data-anchor-id="visualize-lag-correlations">Visualize Lag Correlations</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample one station to visualize</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>example_station <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">==</span> <span class="fu">first</span>(start_station)) <span class="sc">%&gt;%</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">168</span>)  <span class="co"># One week</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot actual vs lagged demand</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(example_station, <span class="fu">aes</span>(<span class="at">x =</span> interval60)) <span class="sc">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Trip_Count, <span class="at">color =</span> <span class="st">"Current"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> lag1Hour, <span class="at">color =</span> <span class="st">"1 Hour Ago"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> lag1day, <span class="at">color =</span> <span class="st">"24 Hours Ago"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Current"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>,</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1 Hour Ago"</span> <span class="ot">=</span> <span class="st">"#3182bd"</span>,</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"24 Hours Ago"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Temporal Lag Patterns at One Station"</span>,</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Past demand predicts future demand"</span>,</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date-Time"</span>,</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Trip Count"</span>,</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Time Period"</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/lag_correlations-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="temporal-traintest-split" class="level1">
<h1>Temporal Train/Test Split</h1>
<p><strong>CRITICAL:</strong> We must train on PAST data and test on FUTURE data!</p>
<section id="why-temporal-validation-matters" class="level2">
<h2 class="anchored" data-anchor-id="why-temporal-validation-matters">Why Temporal Validation Matters</h2>
<p>In real operations, at 6:00 AM on March 15, we need to predict demand for March 15-31. We have data from Jan 1 - March 14, but NOT from March 15-31 (it hasn’t happened yet!).</p>
<p><strong>Wrong approach:</strong> Train on weeks 10-13, test on weeks 1-9 (predicting past from future!)</p>
<p><strong>Correct approach:</strong> Train on weeks 1-9, test on weeks 10-13 (predicting future from past)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split by week</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Q3 has weeks 27-39 (July-Sep)</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Train on weeks 27-36 (July 1 - early Sep)</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test on weeks 36-39 (rest of Sep)</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Which stations have trips in BOTH early and late periods?</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>early_stations <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&lt;</span> <span class="dv">36</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trip_Count <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>late_stations <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&gt;=</span> <span class="dv">36</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trip_Count <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(start_station) <span class="sc">%&gt;%</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(start_station)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only stations that appear in BOTH periods</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>common_stations <span class="ot">&lt;-</span> <span class="fu">intersect</span>(early_stations, late_stations)</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter panel to only common stations</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>study_panel_complete <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(start_station <span class="sc">%in%</span> common_stations)</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="co"># NOW create train/test split</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&lt;</span> <span class="dv">36</span>)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> study_panel_complete <span class="sc">%&gt;%</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(week <span class="sc">&gt;=</span> <span class="dv">36</span>)</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Training observations:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(train), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Training observations: 464,195 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing observations:"</span>, <span class="fu">format</span>(<span class="fu">nrow</span>(test), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing observations: 207,244 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Training date range:"</span>, <span class="fu">min</span>(train<span class="sc">$</span>date), <span class="st">"to"</span>, <span class="fu">max</span>(train<span class="sc">$</span>date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Training date range: 20274 to 20333 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing date range:"</span>, <span class="fu">min</span>(test<span class="sc">$</span>date), <span class="st">"to"</span>, <span class="fu">max</span>(test<span class="sc">$</span>date), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Testing date range: 20334 to 20361 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="build-predictive-models" class="level1">
<h1>Build Predictive Models</h1>
<p>We’ll build 5 models with increasing complexity to see what improves predictions.</p>
<section id="model-1-baseline-time-weather" class="level2">
<h2 class="anchored" data-anchor-id="model-1-baseline-time-weather">Model 1: Baseline (Time + Weather)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create day of week factor with treatment (dummy) coding</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dotw_simple =</span> <span class="fu">factor</span>(dotw, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>)))</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set contrasts to treatment coding (dummy variables)</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(train<span class="sc">$</span>dotw_simple) <span class="ot">&lt;-</span> <span class="fu">contr.treatment</span>(<span class="dv">7</span>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Now run the model</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation,</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-1.7488 -0.7597 -0.2079  0.2120 21.1050 

Coefficients:
                    Estimate Std. Error t value             Pr(&gt;|t|)    
(Intercept)        0.3682491  0.0270944  13.591 &lt; 0.0000000000000002 ***
as.factor(hour)1  -0.0524469  0.0126346  -4.151     0.00003309870185 ***
as.factor(hour)2  -0.1258408  0.0127281  -9.887 &lt; 0.0000000000000002 ***
as.factor(hour)3  -0.1768582  0.0127195 -13.905 &lt; 0.0000000000000002 ***
as.factor(hour)4  -0.1658679  0.0125123 -13.256 &lt; 0.0000000000000002 ***
as.factor(hour)5  -0.0547020  0.0128611  -4.253     0.00002106887679 ***
as.factor(hour)6   0.1873902  0.0125605  14.919 &lt; 0.0000000000000002 ***
as.factor(hour)7   0.4560745  0.0125870  36.234 &lt; 0.0000000000000002 ***
as.factor(hour)8   0.9416129  0.0125198  75.210 &lt; 0.0000000000000002 ***
as.factor(hour)9   0.6276052  0.0127047  49.400 &lt; 0.0000000000000002 ***
as.factor(hour)10  0.4834604  0.0125652  38.476 &lt; 0.0000000000000002 ***
as.factor(hour)11  0.5281827  0.0121913  43.325 &lt; 0.0000000000000002 ***
as.factor(hour)12  0.6158844  0.0123947  49.689 &lt; 0.0000000000000002 ***
as.factor(hour)13  0.6891155  0.0125768  54.792 &lt; 0.0000000000000002 ***
as.factor(hour)14  0.7559300  0.0124246  60.841 &lt; 0.0000000000000002 ***
as.factor(hour)15  0.8648970  0.0125051  69.163 &lt; 0.0000000000000002 ***
as.factor(hour)16  1.0831084  0.0126702  85.485 &lt; 0.0000000000000002 ***
as.factor(hour)17  1.4375105  0.0128842 111.572 &lt; 0.0000000000000002 ***
as.factor(hour)18  1.0852029  0.0128307  84.579 &lt; 0.0000000000000002 ***
as.factor(hour)19  0.8735245  0.0129826  67.284 &lt; 0.0000000000000002 ***
as.factor(hour)20  0.6011154  0.0127982  46.969 &lt; 0.0000000000000002 ***
as.factor(hour)21  0.4227890  0.0125658  33.646 &lt; 0.0000000000000002 ***
as.factor(hour)22  0.2879695  0.0124415  23.146 &lt; 0.0000000000000002 ***
as.factor(hour)23  0.1280527  0.0124667  10.272 &lt; 0.0000000000000002 ***
dotw_simple2       0.1042901  0.0066564  15.668 &lt; 0.0000000000000002 ***
dotw_simple3       0.0366454  0.0067196   5.454     0.00000004940690 ***
dotw_simple4       0.0458157  0.0066479   6.892     0.00000000000552 ***
dotw_simple5       0.0989077  0.0070119  14.106 &lt; 0.0000000000000002 ***
dotw_simple6       0.0041096  0.0069015   0.595                0.552    
dotw_simple7      -0.0648442  0.0066994  -9.679 &lt; 0.0000000000000002 ***
Temperature       -0.0021649  0.0003221  -6.721     0.00000000001810 ***
Precipitation     -0.3599307  0.0270714 -13.296 &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.237 on 464163 degrees of freedom
Multiple R-squared:  0.1089,    Adjusted R-squared:  0.1088 
F-statistic:  1830 on 31 and 464163 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
<p>The model uses Monday as the baseline. Each coefficient represents the difference in expected trips per station-hour compared to Monday - dow_simple2 = Tuesday.</p>
<p><strong>Weekday Pattern (Tue-Fri):</strong></p>
<ul>
<li>All weekdays have positive coefficients (0.026 to 0.088)</li>
<li>Friday has the highest weekday effect (+0.088)</li>
<li>Weekdays likely benefit from concentrated commuting patterns</li>
</ul>
<p><strong>Weekend Pattern (Sat-Sun):</strong></p>
<ul>
<li>Only Sunday weekend days have a negative coefficient (-0.065) while Saturday has a positive (+0.0064)</li>
</ul>
<p><strong>Hourly Interpretation</strong></p>
<p>Hour Coefficient Interpretation 0 (baseline) 0.000 trips/hour (midnight) 1 -0.054 slightly fewer than midnight … 6 +0.184 morning activity starting 7 +0.450 morning rush building 8 +0.937 PEAK morning rush 9 +0.614 post-rush … 17 +1.401 PEAK evening rush (5 PM) 18 +1.058 evening declining … 23 +0.131 late night minimal</p>
</section>
<section id="model-2-add-temporal-lags" class="level2">
<h2 class="anchored" data-anchor-id="model-2-add-temporal-lags">Model 2: Add Temporal Lags</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation + lag1Hour + lag3Hours + lag1day, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-8.0652 -0.4805 -0.1328  0.1699 17.4097 

Coefficients:
                    Estimate Std. Error t value             Pr(&gt;|t|)    
(Intercept)        0.1517212  0.0231242   6.561      0.0000000000534 ***
as.factor(hour)1   0.0050328  0.0107803   0.467              0.64060    
as.factor(hour)2  -0.0138561  0.0108633  -1.276              0.20213    
as.factor(hour)3  -0.0321651  0.0108597  -2.962              0.00306 ** 
as.factor(hour)4  -0.0004616  0.0106885  -0.043              0.96555    
as.factor(hour)5   0.0967690  0.0109891   8.806 &lt; 0.0000000000000002 ***
as.factor(hour)6   0.2704594  0.0107360  25.192 &lt; 0.0000000000000002 ***
as.factor(hour)7   0.4132746  0.0107637  38.395 &lt; 0.0000000000000002 ***
as.factor(hour)8   0.7128398  0.0107183  66.507 &lt; 0.0000000000000002 ***
as.factor(hour)9   0.2635703  0.0108823  24.220 &lt; 0.0000000000000002 ***
as.factor(hour)10  0.1961770  0.0107428  18.261 &lt; 0.0000000000000002 ***
as.factor(hour)11  0.2828768  0.0104193  27.149 &lt; 0.0000000000000002 ***
as.factor(hour)12  0.3467520  0.0105967  32.723 &lt; 0.0000000000000002 ***
as.factor(hour)13  0.3904312  0.0107558  36.300 &lt; 0.0000000000000002 ***
as.factor(hour)14  0.4453933  0.0106272  41.911 &lt; 0.0000000000000002 ***
as.factor(hour)15  0.5177799  0.0107026  48.379 &lt; 0.0000000000000002 ***
as.factor(hour)16  0.6693837  0.0108560  61.660 &lt; 0.0000000000000002 ***
as.factor(hour)17  0.9030493  0.0110698  81.578 &lt; 0.0000000000000002 ***
as.factor(hour)18  0.4893097  0.0110539  44.266 &lt; 0.0000000000000002 ***
as.factor(hour)19  0.3743646  0.0111577  33.552 &lt; 0.0000000000000002 ***
as.factor(hour)20  0.1886039  0.0109998  17.146 &lt; 0.0000000000000002 ***
as.factor(hour)21  0.1666560  0.0107593  15.489 &lt; 0.0000000000000002 ***
as.factor(hour)22  0.1298422  0.0106320  12.212 &lt; 0.0000000000000002 ***
as.factor(hour)23  0.0638527  0.0106388   6.002      0.0000000019524 ***
dotw_simple2       0.0385025  0.0056813   6.777      0.0000000000123 ***
dotw_simple3      -0.0040894  0.0057344  -0.713              0.47577    
dotw_simple4       0.0183779  0.0056725   3.240              0.00120 ** 
dotw_simple5       0.0191991  0.0059886   3.206              0.00135 ** 
dotw_simple6      -0.0282515  0.0058924  -4.795      0.0000016307921 ***
dotw_simple7      -0.0488761  0.0057166  -8.550 &lt; 0.0000000000000002 ***
Temperature       -0.0026041  0.0002749  -9.472 &lt; 0.0000000000000002 ***
Precipitation     -0.0924507  0.0231301  -3.997      0.0000641644538 ***
lag1Hour           0.3997495  0.0013675 292.320 &lt; 0.0000000000000002 ***
lag3Hours          0.1256638  0.0013447  93.451 &lt; 0.0000000000000002 ***
lag1day            0.1416324  0.0012445 113.804 &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.056 on 464160 degrees of freedom
Multiple R-squared:  0.3514,    Adjusted R-squared:  0.3514 
F-statistic:  7397 on 34 and 464160 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
<p><strong>Question:</strong> Did adding lags improve R²? Why or why not?</p>
<p>Yes, adding lag variables greatly improved the R² from 0.1062 to 0.3526. This is because ridership is strongly auto correlated meaning that the number of trips in a given hour depend on trips that happened previously - bike demand is temporal and also patterned and cyclical (rush hours, time of year like students coming back in August, and adding time is less noisy than the weather variable).</p>
</section>
<section id="model-3-add-demographics" class="level2">
<h2 class="anchored" data-anchor-id="model-3-add-demographics">Model 3: Add Demographics</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation + lag1Hour + lag3Hours + lag1day + Med_Inc.x + 
    Percent_Taking_Transit.y + Percent_White.y, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-6.7333 -0.7395 -0.2690  0.4612 17.0509 

Coefficients:
                              Estimate    Std. Error t value
(Intercept)               0.9124583540  0.0518050679  17.613
as.factor(hour)1          0.0908102512  0.0372008493   2.441
as.factor(hour)2         -0.0168983180  0.0412507019  -0.410
as.factor(hour)3         -0.1090948792  0.0484549671  -2.251
as.factor(hour)4         -0.0824845255  0.0441874329  -1.867
as.factor(hour)5          0.0483567208  0.0348432205   1.388
as.factor(hour)6          0.2395443810  0.0296970726   8.066
as.factor(hour)7          0.3614287436  0.0281316543  12.848
as.factor(hour)8          0.7185249130  0.0270794670  26.534
as.factor(hour)9          0.0973848673  0.0275035768   3.541
as.factor(hour)10         0.0565382169  0.0276687465   2.043
as.factor(hour)11         0.1408814346  0.0271324155   5.192
as.factor(hour)12         0.2279907560  0.0272051962   8.380
as.factor(hour)13         0.2727282649  0.0272704651  10.001
as.factor(hour)14         0.3221692226  0.0269756701  11.943
as.factor(hour)15         0.4004098876  0.0269313573  14.868
as.factor(hour)16         0.6365484724  0.0269780592  23.595
as.factor(hour)17         0.9343347246  0.0269879403  34.620
as.factor(hour)18         0.4204094079  0.0272368975  15.435
as.factor(hour)19         0.2963802784  0.0276344611  10.725
as.factor(hour)20         0.0958521108  0.0280349078   3.419
as.factor(hour)21         0.1075895157  0.0283460496   3.796
as.factor(hour)22         0.1008011517  0.0290615724   3.469
as.factor(hour)23         0.0226518792  0.0304195344   0.745
dotw_simple2              0.0711711700  0.0118514838   6.005
dotw_simple3             -0.0158120091  0.0120194501  -1.316
dotw_simple4              0.0303529206  0.0119195442   2.546
dotw_simple5              0.0131942165  0.0123166648   1.071
dotw_simple6              0.0280243274  0.0123672199   2.266
dotw_simple7             -0.0180702320  0.0122886648  -1.470
Temperature              -0.0008759491  0.0005530565  -1.584
Precipitation            -0.7625965365  0.0745475135 -10.230
lag1Hour                  0.2997553139  0.0021213871 141.302
lag3Hours                 0.0894704552  0.0021875613  40.900
lag1day                   0.1130869851  0.0020583035  54.942
Med_Inc.x                 0.0000008997  0.0000001155   7.790
Percent_Taking_Transit.y -0.0041528216  0.0004234566  -9.807
Percent_White.y           0.0025077079  0.0002063528  12.153
                                     Pr(&gt;|t|)    
(Intercept)              &lt; 0.0000000000000002 ***
as.factor(hour)1                     0.014644 *  
as.factor(hour)2                     0.682064    
as.factor(hour)3                     0.024357 *  
as.factor(hour)4                     0.061946 .  
as.factor(hour)5                     0.165188    
as.factor(hour)6          0.00000000000000073 ***
as.factor(hour)7         &lt; 0.0000000000000002 ***
as.factor(hour)8         &lt; 0.0000000000000002 ***
as.factor(hour)9                     0.000399 ***
as.factor(hour)10                    0.041015 *  
as.factor(hour)11         0.00000020788321907 ***
as.factor(hour)12        &lt; 0.0000000000000002 ***
as.factor(hour)13        &lt; 0.0000000000000002 ***
as.factor(hour)14        &lt; 0.0000000000000002 ***
as.factor(hour)15        &lt; 0.0000000000000002 ***
as.factor(hour)16        &lt; 0.0000000000000002 ***
as.factor(hour)17        &lt; 0.0000000000000002 ***
as.factor(hour)18        &lt; 0.0000000000000002 ***
as.factor(hour)19        &lt; 0.0000000000000002 ***
as.factor(hour)20                    0.000629 ***
as.factor(hour)21                    0.000147 ***
as.factor(hour)22                    0.000523 ***
as.factor(hour)23                    0.456485    
dotw_simple2              0.00000000191429276 ***
dotw_simple3                         0.188332    
dotw_simple4                         0.010882 *  
dotw_simple5                         0.284059    
dotw_simple6                         0.023452 *  
dotw_simple7                         0.141434    
Temperature                          0.113234    
Precipitation            &lt; 0.0000000000000002 ***
lag1Hour                 &lt; 0.0000000000000002 ***
lag3Hours                &lt; 0.0000000000000002 ***
lag1day                  &lt; 0.0000000000000002 ***
Med_Inc.x                 0.00000000000000675 ***
Percent_Taking_Transit.y &lt; 0.0000000000000002 ***
Percent_White.y          &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.313 on 165327 degrees of freedom
  (298830 observations deleted due to missingness)
Multiple R-squared:  0.2464,    Adjusted R-squared:  0.2462 
F-statistic:  1461 on 37 and 165327 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
<p><strong>Question:</strong> Did demographics improve R²?</p>
<p>No, demographics decreased the R² from 0.3526 to 0.247. This was an NA data issue where around two thirds of the data set was dropped from the training set. The temporal autocorrelation still dominates the model so demographics don’t add much to the predictive value of the model.</p>
</section>
<section id="model-4-add-station-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="model-4-add-station-fixed-effects">Model 4: Add Station Fixed Effects</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y <span class="sc">+</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(start_station),</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary too long with all station dummies, just show key metrics</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 4 R-squared:"</span>, <span class="fu">summary</span>(model4)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 4 R-squared: 0.2761157 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 4 Adj R-squared:"</span>, <span class="fu">summary</span>(model4)<span class="sc">$</span>adj.r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 4 Adj R-squared: 0.2748176 </code></pre>
</div>
</div>
<p><strong>What do station fixed effects capture?</strong> Baseline differences in demand across stations.</p>
<p>They remove the noise of all time invariable characteristics like access, land-use context, neighborhood density, proximity to amenities etc. This controls for these factors so the model can just compare within-station variation over time.</p>
</section>
<section id="model-5-add-rush-hour-interaction" class="level2">
<h2 class="anchored" data-anchor-id="model-5-add-rush-hour-interaction">Model 5: Add Rush Hour Interaction</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>model5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day <span class="sc">+</span> rush_hour <span class="sc">+</span> <span class="fu">as.factor</span>(month) <span class="sc">+</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    Med_Inc.x <span class="sc">+</span> Percent_Taking_Transit.y <span class="sc">+</span> Percent_White.y <span class="sc">+</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(start_station) <span class="sc">+</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    rush_hour <span class="sc">*</span> weekend,  <span class="co"># Rush hour effects different on weekends</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 5 R-squared:"</span>, <span class="fu">summary</span>(model5)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 5 R-squared: 0.2815065 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 5 Adj R-squared:"</span>, <span class="fu">summary</span>(model5)<span class="sc">$</span>adj.r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 5 Adj R-squared: 0.2802051 </code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="model-evaluation" class="level1">
<h1>Model Evaluation</h1>
<section id="calculate-predictions-and-mae" class="level2">
<h2 class="anchored" data-anchor-id="calculate-predictions-and-mae">Calculate Predictions and MAE</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions on test set</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create day of week factor with treatment (dummy) coding</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dotw_simple =</span> <span class="fu">factor</span>(dotw, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>)))</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set contrasts to treatment coding (dummy variables)</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(test<span class="sc">$</span>dotw_simple) <span class="ot">&lt;-</span> <span class="fu">contr.treatment</span>(<span class="dv">7</span>)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred1 =</span> <span class="fu">predict</span>(model1, <span class="at">newdata =</span> test),</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred2 =</span> <span class="fu">predict</span>(model2, <span class="at">newdata =</span> test),</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred3 =</span> <span class="fu">predict</span>(model3, <span class="at">newdata =</span> test),</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred4 =</span> <span class="fu">predict</span>(model4, <span class="at">newdata =</span> test),</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred5 =</span> <span class="fu">predict</span>(model5, <span class="at">newdata =</span> test)</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE for each model</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>mae_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1. Time + Weather"</span>,</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2. + Temporal Lags"</span>,</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"3. + Demographics"</span>,</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"4. + Station FE"</span>,</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5. + Rush Hour Interaction"</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE =</span> <span class="fu">c</span>(</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred1), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred2), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred3), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred4), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred5), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(mae_results, </span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Mean Absolute Error by Model (Test Set)"</span>,</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"MAE (trips)"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small">
<caption>Mean Absolute Error by Model (Test Set)</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">MAE (trips)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1. Time + Weather</td>
<td style="text-align: right;">0.84</td>
</tr>
<tr class="even">
<td style="text-align: left;">2. + Temporal Lags</td>
<td style="text-align: right;">0.71</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3. + Demographics</td>
<td style="text-align: right;">0.97</td>
</tr>
<tr class="even">
<td style="text-align: left;">4. + Station FE</td>
<td style="text-align: right;">0.95</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5. + Rush Hour Interaction</td>
<td style="text-align: right;">0.96</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="visualize-model-comparison" class="level2">
<h2 class="anchored" data-anchor-id="visualize-model-comparison">Visualize Model Comparison</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mae_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Model, <span class="sc">-</span>MAE), <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"#3182bd"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(MAE, <span class="dv">2</span>)), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Performance Comparison"</span>,</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower MAE = Better Predictions"</span>,</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Model"</span>,</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Absolute Error (trips)"</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  plotTheme <span class="sc">+</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/compare_models-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> Which features gave us the biggest improvement?</p>
<p>The second model: temporal lag gave the best performance, lowest MAE, at 0.71 because bike share demand is temporal and this model best captures this dependance.</p>
<hr>
</section>
</section>
<section id="space-time-error-analysis" class="level1">
<h1>Space-Time Error Analysis</h1>
<section id="observed-vs.-predicted" class="level2">
<h2 class="anchored" data-anchor-id="observed-vs.-predicted">Observed vs.&nbsp;Predicted</h2>
<p>Let’s use our best model (Model 2) for error analysis.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> Trip_Count <span class="sc">-</span> pred2,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_error =</span> <span class="fu">abs</span>(error),</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_of_day =</span> <span class="fu">case_when</span>(</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&lt;</span> <span class="dv">7</span> <span class="sc">~</span> <span class="st">"Overnight"</span>,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">7</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;</span> <span class="dv">10</span> <span class="sc">~</span> <span class="st">"AM Rush"</span>,</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">10</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;</span> <span class="dv">15</span> <span class="sc">~</span> <span class="st">"Mid-Day"</span>,</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;=</span> <span class="dv">15</span> <span class="sc">&amp;</span> hour <span class="sc">&lt;=</span> <span class="dv">18</span> <span class="sc">~</span> <span class="st">"PM Rush"</span>,</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>      hour <span class="sc">&gt;</span> <span class="dv">18</span> <span class="sc">~</span> <span class="st">"Evening"</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot by time and day type</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test, <span class="fu">aes</span>(<span class="at">x =</span> Trip_Count, <span class="at">y =</span> pred2)) <span class="sc">+</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(weekend <span class="sc">~</span> time_of_day) <span class="sc">+</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Observed vs. Predicted Bike Trips"</span>,</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Model 2 performance by time period"</span>,</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Observed Trips"</span>,</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Trips"</span>,</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Red line = perfect predictions; Green line = actual model fit"</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>  plotTheme</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/obs_vs_pred-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> Where is the model performing well? Where is it struggling?</p>
<p>The model really only performs well at stations with low volume demand (such as below 5 observed trips). Unfortunately, the model under predicts high demand periods like rush hour and high volume stations (those that are greater than 5 or so observed trips). This could be due to the model missing non-linear dynamics that impact ridership.</p>
</section>
<section id="spatial-error-patterns" class="level2">
<h2 class="anchored" data-anchor-id="spatial-error-patterns">Spatial Error Patterns</h2>
<p>Are prediction errors clustered in certain parts of Philadelphia?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE by station</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>station_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station, start_lat.x, start_lon.y) <span class="sc">%&gt;%</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(abs_error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_demand =</span> <span class="fu">mean</span>(Trip_Count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat.x), <span class="sc">!</span><span class="fu">is.na</span>(start_lon.y))</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Create Two Maps Side-by-Side with Proper Legends (sorry these maps are ugly)</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate station errors</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>station_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pred2)) <span class="sc">%&gt;%</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(start_station, start_lat.x, start_lon.y) <span class="sc">%&gt;%</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(Trip_Count <span class="sc">-</span> pred2), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_demand =</span> <span class="fu">mean</span>(Trip_Count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(start_lat.x), <span class="sc">!</span><span class="fu">is.na</span>(start_lon.y))</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 1: Prediction Errors</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon, <span class="at">y =</span> start_lat, <span class="at">color =</span> MAE),</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span>,</span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"MAE</span><span class="sc">\n</span><span class="st">(trips)"</span>,</span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>),  <span class="co"># Fewer, cleaner breaks</span></span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>)</span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction Errors"</span>,</span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Higher in Center City"</span>) <span class="sc">+</span></span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">12</span>,</span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 2: Average Demand</span></span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb78-62"><a href="#cb78-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> avg_demand),</span>
<span id="cb78-63"><a href="#cb78-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb78-64"><a href="#cb78-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb78-65"><a href="#cb78-65" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-66"><a href="#cb78-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb78-67"><a href="#cb78-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb78-68"><a href="#cb78-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Avg</span><span class="sc">\n</span><span class="st">Demand"</span>,</span>
<span id="cb78-69"><a href="#cb78-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb78-70"><a href="#cb78-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>),  <span class="co"># Clear breaks</span></span>
<span id="cb78-71"><a href="#cb78-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>, <span class="st">"2.0"</span>, <span class="st">"2.5"</span>)</span>
<span id="cb78-72"><a href="#cb78-72" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-73"><a href="#cb78-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Average Demand"</span>,</span>
<span id="cb78-74"><a href="#cb78-74" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Trips per station-hour"</span>) <span class="sc">+</span></span>
<span id="cb78-75"><a href="#cb78-75" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb78-76"><a href="#cb78-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb78-77"><a href="#cb78-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb78-78"><a href="#cb78-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb78-79"><a href="#cb78-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb78-80"><a href="#cb78-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb78-81"><a href="#cb78-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb78-82"><a href="#cb78-82" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-83"><a href="#cb78-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb78-84"><a href="#cb78-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb78-85"><a href="#cb78-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">12</span>,</span>
<span id="cb78-86"><a href="#cb78-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb78-87"><a href="#cb78-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb78-88"><a href="#cb78-88" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb78-89"><a href="#cb78-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-90"><a href="#cb78-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-91"><a href="#cb78-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-92"><a href="#cb78-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-93"><a href="#cb78-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 1: Prediction Errors</span></span>
<span id="cb78-94"><a href="#cb78-94" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb78-95"><a href="#cb78-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb78-96"><a href="#cb78-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb78-97"><a href="#cb78-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb78-98"><a href="#cb78-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> MAE),</span>
<span id="cb78-99"><a href="#cb78-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb78-100"><a href="#cb78-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb78-101"><a href="#cb78-101" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-102"><a href="#cb78-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb78-103"><a href="#cb78-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span>,</span>
<span id="cb78-104"><a href="#cb78-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"MAE (trips)"</span>,</span>
<span id="cb78-105"><a href="#cb78-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb78-106"><a href="#cb78-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>),</span>
<span id="cb78-107"><a href="#cb78-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>)</span>
<span id="cb78-108"><a href="#cb78-108" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-109"><a href="#cb78-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction Errors"</span>) <span class="sc">+</span></span>
<span id="cb78-110"><a href="#cb78-110" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb78-111"><a href="#cb78-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb78-112"><a href="#cb78-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb78-113"><a href="#cb78-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb78-114"><a href="#cb78-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb78-115"><a href="#cb78-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb78-116"><a href="#cb78-116" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-117"><a href="#cb78-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb78-118"><a href="#cb78-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="dv">12</span>,</span>
<span id="cb78-119"><a href="#cb78-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">1</span>,</span>
<span id="cb78-120"><a href="#cb78-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb78-121"><a href="#cb78-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb78-122"><a href="#cb78-122" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb78-123"><a href="#cb78-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-124"><a href="#cb78-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Map 2: Average Demand  </span></span>
<span id="cb78-125"><a href="#cb78-125" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb78-126"><a href="#cb78-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> philly_census, <span class="at">fill =</span> <span class="st">"grey95"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb78-127"><a href="#cb78-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb78-128"><a href="#cb78-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> station_errors,</span>
<span id="cb78-129"><a href="#cb78-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> start_lon.y, <span class="at">y =</span> start_lat.x, <span class="at">color =</span> avg_demand),</span>
<span id="cb78-130"><a href="#cb78-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb78-131"><a href="#cb78-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.7</span></span>
<span id="cb78-132"><a href="#cb78-132" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-133"><a href="#cb78-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(</span>
<span id="cb78-134"><a href="#cb78-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"viridis"</span>,</span>
<span id="cb78-135"><a href="#cb78-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Avg Demand (trips/hour)"</span>,</span>
<span id="cb78-136"><a href="#cb78-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb78-137"><a href="#cb78-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>),</span>
<span id="cb78-138"><a href="#cb78-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0.5"</span>, <span class="st">"1.0"</span>, <span class="st">"1.5"</span>, <span class="st">"2.0"</span>, <span class="st">"2.5"</span>)</span>
<span id="cb78-139"><a href="#cb78-139" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-140"><a href="#cb78-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Average Demand"</span>) <span class="sc">+</span></span>
<span id="cb78-141"><a href="#cb78-141" aria-hidden="true" tabindex="-1"></a>  mapTheme <span class="sc">+</span></span>
<span id="cb78-142"><a href="#cb78-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb78-143"><a href="#cb78-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb78-144"><a href="#cb78-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb78-145"><a href="#cb78-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb78-146"><a href="#cb78-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb78-147"><a href="#cb78-147" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-148"><a href="#cb78-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_colorbar</span>(</span>
<span id="cb78-149"><a href="#cb78-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">barwidth =</span> <span class="dv">12</span>,</span>
<span id="cb78-150"><a href="#cb78-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">barheight =</span> <span class="dv">1</span>,</span>
<span id="cb78-151"><a href="#cb78-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb78-152"><a href="#cb78-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.hjust =</span> <span class="fl">0.5</span></span>
<span id="cb78-153"><a href="#cb78-153" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb78-154"><a href="#cb78-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-155"><a href="#cb78-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine</span></span>
<span id="cb78-156"><a href="#cb78-156" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb78-157"><a href="#cb78-157" aria-hidden="true" tabindex="-1"></a>  p1, p2,</span>
<span id="cb78-158"><a href="#cb78-158" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb78-159"><a href="#cb78-159" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/spatial_errors-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/spatial_errors-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Question:</strong> Do you see spatial clustering of errors? What neighborhoods have high errors?</p>
<p>The areas such as center city and university city have the highest demand and also highest MAE. This is expected based on the model performance where it cannot account for large volume stations or other non-linear aspects of the problem. For example, 30th street station or bike shares around the universities may have different peak or surge behaviors from other variables aside from what we used in the model like train arrival times or large university events etc.</p>
</section>
<section id="temporal-error-patterns" class="level2">
<h2 class="anchored" data-anchor-id="temporal-error-patterns">Temporal Error Patterns</h2>
<p>When are we most wrong?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MAE by time of day and day type</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>temporal_errors <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(time_of_day, weekend) <span class="sc">%&gt;%</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(abs_error, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day_type =</span> <span class="fu">ifelse</span>(weekend <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>))</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(temporal_errors, <span class="fu">aes</span>(<span class="at">x =</span> time_of_day, <span class="at">y =</span> MAE, <span class="at">fill =</span> day_type)) <span class="sc">+</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> <span class="st">"#08519c"</span>, <span class="st">"Weekend"</span> <span class="ot">=</span> <span class="st">"#6baed6"</span>)) <span class="sc">+</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Errors by Time Period"</span>,</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"When is the model struggling most?"</span>,</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time of Day"</span>,</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Absolute Error (trips)"</span>,</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Day Type"</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>  plotTheme <span class="sc">+</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/temporal_errors-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="errors-and-demographics" class="level2">
<h2 class="anchored" data-anchor-id="errors-and-demographics">Errors and Demographics</h2>
<p>Are prediction errors related to neighborhood characteristics?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join demographic data to station errors</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>station_errors_demo <span class="ot">&lt;-</span> station_errors <span class="sc">%&gt;%</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    station_attributes <span class="sc">%&gt;%</span> <span class="fu">select</span>(start_station, Med_Inc, Percent_Taking_Transit, Percent_White),</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"start_station"</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Med_Inc))</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plots</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Med_Inc, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Median Income"</span>, <span class="at">x =</span> <span class="st">"Median Income"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Percent_Taking_Transit, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Transit Usage"</span>, <span class="at">x =</span> <span class="st">"% Taking Transit"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(station_errors_demo, <span class="fu">aes</span>(<span class="at">x =</span> Percent_White, <span class="at">y =</span> MAE)) <span class="sc">+</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"#3182bd"</span>) <span class="sc">+</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Errors vs. Race"</span>, <span class="at">x =</span> <span class="st">"% White"</span>, <span class="at">y =</span> <span class="st">"MAE"</span>) <span class="sc">+</span></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>  plotTheme</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, p3, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="assignment_5_files/figure-html/errors_demographics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Critical Question:</strong> Are prediction errors systematically higher in certain demographic groups? What are the equity implications?</p>
<p>These prediction errors are consistent with the spatial clustering seen.The model performs best in transit-heavy, often lower-income/majority-minority neighborhoods, and worse in affluent/Whiter neighborhoods with irregular trip patterns.</p>
<hr>
<p><strong>Compare results</strong> to Q1 2025 (Winter):</p>
<ul>
<li>How do MAE values compare? Why might they differ?</li>
</ul>
<p>The MAE in Q1 for Model 2 was 0.50 compared to Q3 Model 3 of 0.71. The summer months are higher demand seasons versus the winter months. This makes predicting summer bike patterns harder because of the higher variance leading to higher MAE.</p>
<ul>
<li>Are temporal patterns different (e.g., summer vs.&nbsp;winter)?</li>
</ul>
<p>Summer and Winter are two very different seasons. Weather is a portion of why summer months are harder to predict as well. Rainstorms and other weather are more sporadic and with higher ridership can disrupt the predictive pattern more easily. Winter is cold everyday, assuming people still riding in the winter are consistent with this aspect, the weather patterns are less interruptive. There are also midday increases in ridership during the summer which could be tourists riding around the city.</p>
<ul>
<li>Which features are most important in your quarter?</li>
</ul>
<p>Again, distance to universities and center city (as seen in the prediction errors maps) spike more in the summer months than in winter months could be helpful. Weather is actually the most important feature (or one of them) as heat and rain coupled with the higher ridership makes it harder to predict summer patters over winter patterns.</p>
</section>
<section id="part-3-feature-engineering-model-improvement-adding-2-3-new-features-to-improve-the-model" class="level2">
<h2 class="anchored" data-anchor-id="part-3-feature-engineering-model-improvement-adding-2-3-new-features-to-improve-the-model">Part 3: Feature Engineering &amp; model improvement: Adding 2-3 new features to improve the model:</h2>
</section>
<section id="add-feature-1-same-hour-last-week" class="level2">
<h2 class="anchored" data-anchor-id="add-feature-1-same-hour-last-week">Add Feature 1: same hour last week</h2>
<p>Added code to lines 581 chunk to add the lag1week variable:</p>
<p>[lag1week = lag(Trip_Count, 168)] and [filter(!is.na(lag1week))]</p>
</section>
<section id="model-6-add-same-hour-one-week-lag" class="level2">
<h2 class="anchored" data-anchor-id="model-6-add-same-hour-one-week-lag">Model 6: Add same hour one week lag</h2>
<p>This variable was chosen based on the predictive value of the temporal lag models. It could potentially improve the model to look back even further in time to predict the future. This was true but only incrementally. The R2 slightly increased to 0.3578 from 0.3513.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>model6 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span> lag1week <span class="sc">+</span> lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day,</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model6)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation + lag1week + lag1Hour + lag3Hours + lag1day, 
    data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-7.8958 -0.4845 -0.1391  0.1704 17.4782 

Coefficients:
                    Estimate Std. Error t value             Pr(&gt;|t|)    
(Intercept)        0.0855497  0.0230243   3.716             0.000203 ***
as.factor(hour)1   0.0009293  0.0107247   0.087             0.930947    
as.factor(hour)2  -0.0218567  0.0108077  -2.022             0.043144 *  
as.factor(hour)3  -0.0436470  0.0108048  -4.040  0.00005355257608722 ***
as.factor(hour)4  -0.0129719  0.0106348  -1.220             0.222557    
as.factor(hour)5   0.0796475  0.0109351   7.284  0.00000000000032546 ***
as.factor(hour)6   0.2605243  0.0106815  24.390 &lt; 0.0000000000000002 ***
as.factor(hour)7   0.4130357  0.0107081  38.572 &lt; 0.0000000000000002 ***
as.factor(hour)8   0.7197802  0.0106634  67.500 &lt; 0.0000000000000002 ***
as.factor(hour)9   0.2789224  0.0108283  25.759 &lt; 0.0000000000000002 ***
as.factor(hour)10  0.2140525  0.0106904  20.023 &lt; 0.0000000000000002 ***
as.factor(hour)11  0.2981352  0.0103678  28.756 &lt; 0.0000000000000002 ***
as.factor(hour)12  0.3494794  0.0105420  33.151 &lt; 0.0000000000000002 ***
as.factor(hour)13  0.3843570  0.0107006  35.919 &lt; 0.0000000000000002 ***
as.factor(hour)14  0.4351710  0.0105733  41.157 &lt; 0.0000000000000002 ***
as.factor(hour)15  0.5117392  0.0106476  48.061 &lt; 0.0000000000000002 ***
as.factor(hour)16  0.6646401  0.0108001  61.540 &lt; 0.0000000000000002 ***
as.factor(hour)17  0.9059036  0.0110127  82.260 &lt; 0.0000000000000002 ***
as.factor(hour)18  0.4937868  0.0109969  44.902 &lt; 0.0000000000000002 ***
as.factor(hour)19  0.3804739  0.0111004  34.276 &lt; 0.0000000000000002 ***
as.factor(hour)20  0.1939857  0.0109432  17.727 &lt; 0.0000000000000002 ***
as.factor(hour)21  0.1705066  0.0107039  15.929 &lt; 0.0000000000000002 ***
as.factor(hour)22  0.1346820  0.0105773  12.733 &lt; 0.0000000000000002 ***
as.factor(hour)23  0.0660513  0.0105839   6.241  0.00000000043592416 ***
dotw_simple2       0.0360465  0.0056520   6.378  0.00000000018004396 ***
dotw_simple3      -0.0033892  0.0057048  -0.594             0.552446    
dotw_simple4       0.0236186  0.0056437   4.185  0.00002852853883764 ***
dotw_simple5       0.0290188  0.0059593   4.870  0.00000111914468811 ***
dotw_simple6      -0.0180855  0.0058638  -3.084             0.002041 ** 
dotw_simple7      -0.0444085  0.0056874  -7.808  0.00000000000000582 ***
Temperature       -0.0022464  0.0002735  -8.212 &lt; 0.0000000000000002 ***
Precipitation     -0.1206957  0.0230142  -5.244  0.00000015685361078 ***
lag1week           0.0873478  0.0012562  69.536 &lt; 0.0000000000000002 ***
lag1Hour           0.3873746  0.0013720 282.336 &lt; 0.0000000000000002 ***
lag3Hours          0.1135726  0.0013490  84.190 &lt; 0.0000000000000002 ***
lag1day            0.1312334  0.0012471 105.231 &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.05 on 464159 degrees of freedom
Multiple R-squared:  0.3581,    Adjusted R-squared:  0.3581 
F-statistic:  7398 on 35 and 464159 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
</section>
<section id="add-feature-2-feels-like-weather" class="level2">
<h2 class="anchored" data-anchor-id="add-feature-2-feels-like-weather">Add Feature 2: “feels-like” weather</h2>
<p>This feature was selected because of the heat aspect of summer months increasing variability and decreasing prediction value. Added Feel variable for feels like temperature in chunk 439. This didn’t change the R2 at all. The Feel variable had very little predictive influence even if it was significant.</p>
</section>
<section id="model-7-add-feels-like-weather" class="level2">
<h2 class="anchored" data-anchor-id="model-7-add-feels-like-weather">Model 7: Add “feels-like” weather</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>model7 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  Trip_Count <span class="sc">~</span> <span class="fu">as.factor</span>(hour) <span class="sc">+</span> dotw_simple <span class="sc">+</span> Temperature <span class="sc">+</span> Precipitation <span class="sc">+</span> Feel <span class="sc">+</span> lag1week <span class="sc">+</span> lag1Hour <span class="sc">+</span> lag3Hours <span class="sc">+</span> lag1day,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> train</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model7)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + 
    Precipitation + Feel + lag1week + lag1Hour + lag3Hours + 
    lag1day, data = train)

Residuals:
    Min      1Q  Median      3Q     Max 
-7.8912 -0.4844 -0.1390  0.1687 17.4738 

Coefficients:
                     Estimate  Std. Error t value             Pr(&gt;|t|)    
(Intercept)        0.02006073  0.02762163   0.726              0.46767    
as.factor(hour)1  -0.00002092  0.01072682  -0.002              0.99844    
as.factor(hour)2  -0.02219227  0.01080782  -2.053              0.04004 *  
as.factor(hour)3  -0.04496122  0.01080894  -4.160   0.0000318817014825 ***
as.factor(hour)4  -0.01425428  0.01063880  -1.340              0.18030    
as.factor(hour)5   0.07925602  0.01093531   7.248   0.0000000000004245 ***
as.factor(hour)6   0.25999822  0.01068202  24.340 &lt; 0.0000000000000002 ***
as.factor(hour)7   0.41311368  0.01070793  38.580 &lt; 0.0000000000000002 ***
as.factor(hour)8   0.71986062  0.01066318  67.509 &lt; 0.0000000000000002 ***
as.factor(hour)9   0.27921512  0.01082832  25.786 &lt; 0.0000000000000002 ***
as.factor(hour)10  0.21462128  0.01069101  20.075 &lt; 0.0000000000000002 ***
as.factor(hour)11  0.29870886  0.01036850  28.809 &lt; 0.0000000000000002 ***
as.factor(hour)12  0.35000087  0.01054254  33.199 &lt; 0.0000000000000002 ***
as.factor(hour)13  0.38466370  0.01070061  35.948 &lt; 0.0000000000000002 ***
as.factor(hour)14  0.43577598  0.01057409  41.212 &lt; 0.0000000000000002 ***
as.factor(hour)15  0.51211343  0.01064778  48.096 &lt; 0.0000000000000002 ***
as.factor(hour)16  0.66332595  0.01080428  61.395 &lt; 0.0000000000000002 ***
as.factor(hour)17  0.90376877  0.01102372  81.984 &lt; 0.0000000000000002 ***
as.factor(hour)18  0.49151142  0.01100951  44.644 &lt; 0.0000000000000002 ***
as.factor(hour)19  0.37656336  0.01113754  33.810 &lt; 0.0000000000000002 ***
as.factor(hour)20  0.19145239  0.01095894  17.470 &lt; 0.0000000000000002 ***
as.factor(hour)21  0.16790069  0.01072088  15.661 &lt; 0.0000000000000002 ***
as.factor(hour)22  0.13316625  0.01058302  12.583 &lt; 0.0000000000000002 ***
as.factor(hour)23  0.06641658  0.01058407   6.275   0.0000000003496090 ***
dotw_simple2       0.03674567  0.00565428   6.499   0.0000000000810770 ***
dotw_simple3      -0.00122939  0.00572687  -0.215              0.83002    
dotw_simple4       0.02690932  0.00569545   4.725   0.0000023051338008 ***
dotw_simple5       0.03036320  0.00596741   5.088   0.0000003616785514 ***
dotw_simple6      -0.01801058  0.00586369  -3.072              0.00213 ** 
dotw_simple7      -0.04317578  0.00569459  -7.582   0.0000000000000341 ***
Temperature        0.00158774  0.00093432   1.699              0.08925 .  
Precipitation     -0.12331679  0.02302185  -5.357   0.0000000848840438 ***
Feel              -0.00292645  0.00068189  -4.292   0.0000177368666740 ***
lag1week           0.08769128  0.00125868  69.669 &lt; 0.0000000000000002 ***
lag1Hour           0.38726884  0.00137223 282.219 &lt; 0.0000000000000002 ***
lag3Hours          0.11341801  0.00134946  84.047 &lt; 0.0000000000000002 ***
lag1day            0.13076172  0.00125191 104.450 &lt; 0.0000000000000002 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.05 on 464158 degrees of freedom
Multiple R-squared:  0.3581,    Adjusted R-squared:  0.3581 
F-statistic:  7194 on 36 and 464158 DF,  p-value: &lt; 0.00000000000000022</code></pre>
</div>
</div>
</section>
<section id="model-7-predictive-errors" class="level2">
<h2 class="anchored" data-anchor-id="model-7-predictive-errors">Model 7: Predictive Errors</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create day of week factor with treatment (dummy) coding</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dotw_simple =</span> <span class="fu">factor</span>(dotw, </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>, <span class="st">"Sun"</span>)))</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(test<span class="sc">$</span>dotw_simple) <span class="ot">&lt;-</span> <span class="fu">contr.treatment</span>(<span class="dv">7</span>)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>pred7 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model7, <span class="at">newdata =</span> test)</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE for Model 7</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>mae_model7 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test<span class="sc">$</span>Trip_Count <span class="sc">-</span> test<span class="sc">$</span>pred7), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model 7 MAE:"</span>, <span class="fu">round</span>(mae_model7, <span class="dv">4</span>), <span class="st">"trips</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model 7 MAE: 0.7117 trips</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>mae_results <span class="ot">&lt;-</span> mae_results <span class="sc">%&gt;%</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">Model =</span> <span class="st">"7. + Weekly Lag + Feel"</span>, <span class="at">MAE =</span> mae_model7)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="part-4-critical-reflection" class="level2">
<h2 class="anchored" data-anchor-id="part-4-critical-reflection">Part 4: Critical Reflection</h2>
<p>Write 1-2 paragraphs addressing:</p>
<ol type="1">
<li><p><strong>Operational implications:</strong></p>
<ul>
<li>Is your final MAE “good enough” for Indego to use?</li>
</ul>
<p>My final MAE for model 7 was 0.712. This shapes overall demand still. This may be “good enough” since it is off less than a bike per hour which is better than naive baselines. Though good enough for Indego would be dependent on their goals. This model is really only good for steady, low-volume demand stations.</p>
<ul>
<li>When do prediction errors cause problems for re balancing?</li>
</ul>
<p>The errors come with stations with heavy use, sporadic weather like summer rain fall, heat waves, distance to amenities like universities or center city which have more non-linear usage like large events, or during rush hours.</p>
<ul>
<li>Would you recommend deploying this system? Under what conditions?</li>
</ul>
<p>This system could be helpful in re balancing from and over all stand point. However, there are some conditions in which it is not useful as stated above. There would still need to be real-time demand monitoring, adding weather forecasts like time lags into the prediction would be interesting?</p></li>
<li><p><strong>Equity considerations:</strong></p>
<ul>
<li>Do prediction errors disproportionately affect certain neighborhoods?</li>
</ul>
<p>Yes, however it is largely wealthy/whiter neighborhoods that this model poorly predicts. Instead it does a better job of predicting low-volume/lower-income neighborhoods. Demand is more stable in low-volume areas than in higher, more volatile areas.</p>
<ul>
<li>Could this system worsen existing disparities in bike access?</li>
</ul>
<p>Yes, this model, without safeguards, could worsen existing disparities. Low volume/low income areas could also be a reflection of poor service not just low demand. The existing service seen in the locations map doesn’t represent many lower income neighborhoods already. Predicting demand alone could just reinforce this structure. These models should only be used as guidance.</p>
<ul>
<li>What safeguards would you recommend?</li>
</ul>
<p>Check in’s on predictive capacity by race and income etc. should be done regularly. Also, the city could institute minimum service guarantees that should be encoded and applied to Indego/the city for servicing the city overall.</p></li>
<li><p><strong>Model limitations:</strong></p>
<ul>
<li>What patterns is your model missing?</li>
</ul>
<p>Although the model functions and is “good enough” for use, it still does not encompass non-linear aspects like distance to universities and center city which have nonlinear event patterns and crowd patterns or weather events that are more sporadic throughout the seasons, like summer rain events.</p>
<ul>
<li>What assumptions might not hold in real deployment?</li>
</ul>
<p>The lag week assumption is interesting to add since it improved model performance, yet weekly weather can drastically different than day by day weather. Also, station demand is connected and the model doesn’t account for this. It treats each station individually as an assumption instead.</p>
<ul>
<li>How would you improve this with more time/data?</li>
</ul>
<p>I would add more information to the model like holidays, large events from universities or center city like the convention center, station capacities, or even try more machine learning techniques that can go beyond non-linear modelling.</p></li>
</ol>
<hr>
<p>knitr::convert_chunk_header(“assignment_5.Rmd”, “assignment_5.qmd”)</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>